---
layout: post
title: "rbs-merge v2.0.0 released!"
date: "2026-02-19T13:25:37Z"
tags: ["release", "rbs-merge", "v2.0.0"]
---

## [2.0.0] - 2026-02-19

- TAG: [v2.0.0][2.0.0t]
- COVERAGE: 72.31% -- 713/986 lines in 12 files
- BRANCH COVERAGE: 39.77% -- 208/523 branches in 12 files
- 98.63% documented

### Added

- AGENTS.md
- **Dependency Tags Support**: Added `spec/support/dependency_tags.rb` to load shared
  dependency tags from tree_haver and ast-merge. This enables automatic exclusion of
  tests when required backends or dependencies are not available.
  - Tests tagged with `:ffi_backend`, `:java_backend`, `:rust_backend` are now properly
    excluded when those backends aren't available
  - Tests tagged with `:rbs_grammar` are excluded when tree-sitter-rbs isn't available
  - Tests tagged with `:rbs_parsing` work with any available RBS parsing backend
- FFI backend isolation for test suite
  - Added `bin/rspec-ffi` script to run FFI specs in isolation (before MRI backend loads)
  - Added `spec/spec_ffi_helper.rb` for FFI-specific test configuration
  - Updated Rakefile with `ffi_specs` and `remaining_specs` tasks
  - The `:test` task now runs FFI specs first, then remaining specs
- **BackendRegistry Integration**: RbsBackend now registers its availability checker with `TreeHaver::BackendRegistry`
  - Enables `TreeHaver::RSpec::DependencyTags` to detect RBS backend availability without hardcoded checks
  - Called automatically when backend is loaded: `TreeHaver::BackendRegistry.register_availability_checker(:rbs)`
- **TreeHaver backend integration** - rbs-merge now uses TreeHaver for all parsing,
  enabling cross-platform RBS parsing:
  - **`Rbs::Merge::Backends::RbsBackend`** - New TreeHaver-compatible backend module
    that wraps the RBS gem. Registered with TreeHaver via `register_language(:rbs, ...)`.
  - On MRI: Uses RBS gem backend (richer AST, comment association)
  - On JRuby: Uses tree-sitter-rbs via TreeHaver's Java backend
  - Backend selection respects `TreeHaver.with_backend()` and `TREE_HAVER_BACKEND` env var
- **`NodeWrapper#comment`** - Delegates to underlying RBS gem node's comment for
  leading comment association (RBS gem backend only)
- **`FileAnalysis#compute_tree_sitter_signature`** - Generates signatures for raw
  TreeHaver::Node objects from tree-sitter backend
- **`FileAnalysis#extract_tree_sitter_node_name`** - Extracts declaration names from
  tree-sitter nodes by traversing child nodes
- `node_typing` parameter for per-node-type merge preferences
  - Enables `preference: { default: :destination, special_type: :template }` pattern
  - Works with custom merge_types assigned via node_typing lambdas
- `match_refiner` parameter for fuzzy matching support
- `regions` and `region_placeholder` parameters for nested content merging

### Changed

- appraisal2 v3.0.6
- kettle-test v1.0.10
- stone_checksums v1.0.3
- [ast-merge v4.0.6](https://github.com/kettle-rb/ast-merge/releases/tag/v4.0.6)
- [tree_haver v5.0.5](https://github.com/kettle-rb/tree_haver/releases/tag/v5.0.5)
- tree_stump v0.2.0
  - fork no longer required, updates all applied upstream
- Updated documentation on hostile takeover of RubyGems
  - https://dev.to/galtzo/hostile-takeover-of-rubygems-my-thoughts-5hlo
- **RbsBackend refactored to use TreeHaver::Base classes**
  - `RbsBackend::Language` now inherits from `TreeHaver::Base::Language`
  - `RbsBackend::Parser` now inherits from `TreeHaver::Base::Parser`
  - `RbsBackend::Tree` now inherits from `TreeHaver::Base::Tree`
  - `RbsBackend::Node` now inherits from `TreeHaver::Base::Node`
  - Consistent API across all merge gem backends
- **Tree-sitter grammar registration** - `register_backend!` now registers both:
  - The RBS gem backend (Ruby-based parser, MRI only)
  - The tree-sitter-rbs grammar path (for native tree-sitter backends)
  - This enables `TreeHaver.parser_for(:rbs)` to use tree-sitter when available
- **FileAnalysis now uses TreeHaver exclusively** - Removed separate backend selection
  logic. `parse_rbs` now calls `TreeHaver.parser_for(:rbs)` which handles all backend
  selection automatically.
- **`node_start_line`/`node_end_line` helpers** - Now check for `start_line`/`end_line`
  methods first (TreeHaver::Node has these), falling back to `location` or `start_point`.
- **`ConflictResolver#declarations_identical?`** - Now compares text content instead of
  relying on object equality, enabling cross-backend comparison.
- **`ConflictResolver#canonical_type`** - Now handles TreeHaver::Node objects in addition
  to NodeWrapper and RBS gem nodes.
- **`ConflictResolver#has_members?`** - Now checks for `members` child nodes in
  TreeHaver::Node objects for tree-sitter backend support.
- **`ConflictResolver#resolve`** - Now checks for template freeze blocks first, ensuring
  frozen content from templates is preserved during merge.
- **`FileAligner#build_signature_map`** - FreezeNodes are now indexed by both their own
  signature AND the signatures of their contained nodes. This allows freeze blocks to
  match against the non-frozen version of the same declaration in the other file.
- **`MergeResult#add_freeze_block`** - Now uses the freeze_node's own analysis for line
  extraction, ensuring template freeze blocks use template lines (not destination lines).
- **`SmartMerger#process_match`** - Now handles template FreezeNodes correctly, adding
  them via `add_freeze_block` when the template side wins.
- **`SmartMerger#process_template_only`** - FreezeNodes from template are now always
  added (they represent protected content that must be preserved).
- **SmartMerger**: Added `**options` for forward compatibility
  - Accepts additional options that may be added to base class in future
  - Passes all options through to `SmartMergerBase`
- **ConflictResolver**: Added `**options` for forward compatibility
- **MergeResult**: Added `**options` for forward compatibility
- **BREAKING**: `SmartMerger` now inherits from `Ast::Merge::SmartMergerBase`
  - Provides standardized options API consistent with all other `*-merge` gems
  - Gains automatic support for new SmartMergerBase features
  - `max_recursion_depth` parameter is still supported
  - `preference` now accepts Hash for per-type preferences

### Removed

- **`FileAnalysis#rbs_gem_available?`** - Removed; TreeHaver handles backend availability
- **`FileAnalysis#parse_with_rbs_gem`** - Removed; replaced by `process_rbs_gem_result`
- **`FileAnalysis#parse_with_tree_sitter`** - Removed; replaced by `process_tree_sitter_result`
- **`backend:` parameter from `FileAnalysis#initialize`** - Removed; use
  `TreeHaver.with_backend()` to control backend selection

### Fixed

- ConflictResolver now applies Hash-based per-node-type preferences via `node_typing`.
- **Freeze blocks from template now preserved correctly** - Previously, freeze blocks
  from the template would not match destination declarations because their signatures
  differed. Now FreezeNodes are indexed by contained node signatures.
- **FreezeNode name extraction** - `extract_node_name` now handles TreeHaver::Node
  objects and extracts meaningful names for error messages.
- **`FreezeNode#get_start_line`/`get_end_line`** - Now properly handle nodes with
  direct `start_line`/`end_line` methods (TreeHaver::Node).
- **`SmartMerger#get_start_line`/`get_end_line`** - Added helper methods to support
  both NodeWrapper and RBS gem nodes in `reconstruct_declaration_with_merged_members`.

[2.0.0]: https://github.com/kettle-rb/rbs-merge/compare/v1.0.0...v2.0.0
[2.0.0t]: https://github.com/kettle-rb/rbs-merge/releases/tag/v2.0.0

Official Discord üëâÔ∏è [![Live Chat on Discord][‚úâÔ∏èdiscord-invite-img]][‚úâÔ∏èdiscord-invite]

Many paths lead to being a sponsor or a backer of this project. Are you on such a path?

[![OpenCollective Backers][üñáosc-backers-i]][üñáosc-backers] [![OpenCollective Sponsors][üñáosc-sponsors-i]][üñáosc-sponsors] [![Sponsor Me on Github][üñásponsor-img]][üñásponsor] [![Liberapay Goal Progress][‚õ≥liberapay-img]][‚õ≥liberapay] [![Donate on PayPal][üñápaypal-img]][üñápaypal]

[![Buy me a coffee][üñábuyme-small-img]][üñábuyme] [![Donate on Polar][üñápolar-img]][üñápolar] [![Donate to my FLOSS efforts at ko-fi.com][üñákofi-img]][üñákofi] [![Donate to my FLOSS efforts using Patreon][üñápatreon-img]][üñápatreon]

[‚õ≥liberapay-img]: https://img.shields.io/liberapay/goal/pboling.svg?logo=liberapay&color=a51611&style=flat
[‚õ≥liberapay]: https://liberapay.com/pboling/donate
[üñáosc-backers]: https://opencollective.com/kettle-rb#backer
[üñáosc-backers-i]: https://opencollective.com/kettle-rb/backers/badge.svg?style=flat
[üñáosc-sponsors]: https://opencollective.com/kettle-rb#sponsor
[üñáosc-sponsors-i]: https://opencollective.com/kettle-rb/sponsors/badge.svg?style=flat
[üñásponsor-img]: https://img.shields.io/badge/Sponsor_Me!-pboling.svg?style=social&logo=github
[üñásponsor]: https://github.com/sponsors/pboling
[üñápolar-img]: https://img.shields.io/badge/polar-donate-a51611.svg?style=flat
[üñápolar]: https://polar.sh/pboling
[üñákofi-img]: https://img.shields.io/badge/ko--fi-%E2%9C%93-a51611.svg?style=flat
[üñákofi]: https://ko-fi.com/O5O86SNP4
[üñápatreon-img]: https://img.shields.io/badge/patreon-donate-a51611.svg?style=flat
[üñápatreon]: https://patreon.com/galtzo
[üñábuyme-small-img]: https://img.shields.io/badge/buy_me_a_coffee-%E2%9C%93-a51611.svg?style=flat
[üñábuyme]: https://www.buymeacoffee.com/pboling
[üñápaypal-img]: https://img.shields.io/badge/donate-paypal-a51611.svg?style=flat&logo=paypal
[üñápaypal]: https://www.paypal.com/paypalme/peterboling
[‚úâÔ∏èdiscord-invite]: https://discord.gg/3qme4XHNKN
[‚úâÔ∏èdiscord-invite-img]: https://img.shields.io/discord/1373797679469170758?style=flat
